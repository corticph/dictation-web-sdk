<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        background: #fafafa;
        color: #333;
        font-family: Arial, sans-serif;
        margin: 20px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      @media (prefers-color-scheme: dark) {
        body {
          background: #1c1e2b;
          color: #eee;
        }
      }

      textarea,
      input,
      .component-placeholder {
        background: #333;
        color: #fff;
        width: 100%;
        max-width: 800px;
        padding: 10px;
        font-size: 14px;
        outline: none;
        border: 1px solid #ccc;
      }

      @media (prefers-color-scheme: dark) {
        textarea,
        input,
        .component-placeholder {
          background: #2a2a2a;
          color: #eee;
          border: 1px solid #555;
        }
      }

      #commandOutput {
        font-family: monospace;
      }

      .component-placeholder {
        border-style: dashed;
        border-width: 2px;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
      }

      corti-dictation {
        display: block;
      }

      corti-dictation:not([data-ready]) {
        display: none;
      }
    </style>
  </head>
  <body>
    <input
      type="text"
      id="accessToken"
      placeholder="Paste your access token here"
    />

    <div id="componentPlaceholder" class="component-placeholder">
      The dictation component will load once an auth token is provided.
    </div>

    <corti-dictation id="dictationComponent"></corti-dictation>

    <!-- Textarea to display transcript text -->
    <textarea
      id="transcript"
      rows="6"
      placeholder="Transcript will appear here..."
    ></textarea>
    <div id="commandOutput"></div>

    <script type="module">
      // Import the Corti Dictation SDK
      // import "@corti/dictation-web";
      import '../dist/bundle.js';

      // Get the corti-dictation element and assign the server config
      const dictation = document.querySelector('corti-dictation');
      const accessTokenInput = document.getElementById('accessToken');
      const componentPlaceholder = document.getElementById(
        'componentPlaceholder',
      );
      const dictationComponent = document.getElementById('dictationComponent');

      // Function to set the access token
      function setToken() {
        const token = accessTokenInput.value.trim();
        if (token) {
          try {
            dictation.setAccessToken(token);
            console.log('Access token set successfully');
            // Hide placeholder and show component
            componentPlaceholder.style.display = 'none';
            dictationComponent.setAttribute('data-ready', 'true');
          } catch (e) {
            console.error('Error setting access token:', e);
            // Show placeholder if token is invalid
            componentPlaceholder.style.display = 'block';
            dictationComponent.removeAttribute('data-ready');
          }
        } else {
          // Show placeholder when token is cleared
          componentPlaceholder.style.display = 'block';
          dictationComponent.removeAttribute('data-ready');
        }
      }

      // Set token when input changes (debounced)
      let tokenTimeout;
      accessTokenInput.addEventListener('input', () => {
        clearTimeout(tokenTimeout);
        tokenTimeout = setTimeout(setToken, 500);
      });

      // Also set token on paste
      accessTokenInput.addEventListener('paste', () => {
        setTimeout(setToken, 100);
      });

      dictation.dictationConfig = {
        primaryLanguage: 'en',
        spokenPunctuation: true,
        automaticPunctuation: true,
        commands: [
          { id: 'delete', phrases: ['delete that'] },
          {
            id: 'insert_template',
            phrases: [
              'insert my {template_name} template',
              'insert {template_name} template',
            ],
            variables: [
              {
                key: 'template_name',
                type: 'enum',
                enum: ['new', 'existing'],
              },
            ],
          },
        ],
      };

      // Listen to events from the dictation component
      dictation.addEventListener('recording-state-changed', e => {
        console.log('Recording state:', e.detail.state);
      });

      dictation.addEventListener('recording-devices-changed', e => {
        console.log('Recording Device Changed:', e.detail);
      });

      dictation.addEventListener('devices-changed', e => {
        console.log('Device List Changed:', e.detail);
      });

      dictation.addEventListener('error', e => {
        console.error(e.detail);
      });

      // Update the textarea with transcript text when received
      dictation.addEventListener('transcript', e => {
        const { data } = e.detail;
        const transcriptArea = document.getElementById('transcript');
        if (data.isFinal) {
          transcriptArea.value += data.text + ' ';
        }
      });

      // Update the textarea with transcript text when received
      dictation.addEventListener('command', e => {
        const { data } = e.detail;
        const commandOutput = document.getElementById('commandOutput');
        console.log('Command:', data);
        if (data.id) {
          commandOutput.innerHTML = `Command: ${data.id} (${JSON.stringify(Object.entries(data.variables))})`;
        }
      });
    </script>
  </body>
</html>
